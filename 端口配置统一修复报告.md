# 端口配置统一修复报告

## 问题描述

前端应用中存在多处硬编码的API端口号（8502），与环境配置文件中设置的端口（8002）不一致，导致视频导出功能无法正常工作。

## 错误现象

```
Failed to load resource: net::ERR_CONNECTION_REFUSED
POST http://localhost:8002/api/import net::ERR_CONNECTION_REFUSED
POST http://localhost:8502/api/workflow/execute net::ERR_CONNECTION_REFUSED
```

## 修复内容

### 1. 修复的文件列表

以下文件中的硬编码URL已全部替换为使用配置的`API_BASE_URL`：

#### 组件文件
1. **VideoExportButtonNew.vue**
   - 添加 `import { API_BASE_URL } from '@/config/api'`
   - 替换 3 处硬编码URL：
     - `http://localhost:8502/api/workflow/execute` → `${API_BASE_URL}/api/workflow/execute`
     - `http://localhost:8502/api/workflow/status/${workflowId}` → `${API_BASE_URL}/api/workflow/status/${workflowId}`
     - `http://localhost:8502/api/download/${projectName}/${filename}` → `${API_BASE_URL}/api/download/${projectName}/${filename}`

2. **VideoExportButton.vue**
   - 替换硬编码常量：
     - `const API_BASE_URL = 'http://localhost:8502'` → `import { API_BASE_URL } from '@/config/api'`

3. **ConfigPage.vue** (components目录)
   - 添加 `import { API_BASE_URL } from '@/config/api'`
   - 替换 2 处硬编码URL：
     - `http://localhost:8502/api/config` (GET) → `${API_BASE_URL}/api/config`
     - `http://localhost:8502/api/config` (POST) → `${API_BASE_URL}/api/config`

4. **ProjectList.vue**
   - 添加 `import { API_BASE_URL } from '@/config/api'`
   - 替换 3 处硬编码URL：
     - `http://localhost:8502/api/projects` → `${API_BASE_URL}/api/projects`
     - `http://localhost:8502/api/download/${projectName}` → `${API_BASE_URL}/api/download/${projectName}`
     - `http://localhost:8502/api/projects/${projectName}` → `${API_BASE_URL}/api/projects/${projectName}`

5. **WorkflowProgress.vue**
   - 添加 `import { API_BASE_URL } from '@/config/api'`
   - 替换 1 处硬编码URL：
     - `http://localhost:8502/api/workflow/status` → `${API_BASE_URL}/api/workflow/status`

#### 视图文件
6. **ConfigPage.vue** (views目录)
   - 添加 `import { API_BASE_URL } from '@/config/api'`
   - 替换 2 处硬编码URL：
     - `http://localhost:8502/api/config` (GET) → `${API_BASE_URL}/api/config`
     - `http://localhost:8502/api/config` (POST) → `${API_BASE_URL}/api/config`

### 2. 环境配置确认

**`.env.development`** 配置正确：
```bash
VITE_API_BASE_URL=http://localhost:8002
VITE_API_HOST=localhost
VITE_API_PORT=8002
```

**`src/config/api.ts`** 配置正确：
```typescript
export const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8002'
```

### 3. 启动脚本更新

**`start_dev.bat`** 已更新：
- 使用8002端口启动API服务器
- 使用简化API（`api_simple:app`）确保所有必要的端点可用

### 4. API服务器准备

创建了 **`api_simple.py`** 简化API服务器，包含所有前端需要的端点：
- `/health` - 健康检查
- `/api/ppt/save` - PPT项目保存
- `/api/ppt/auto-save` - PPT自动保存
- `/api/ppt/load/{project_id}` - PPT项目加载
- `/api/ppt/list` - PPT项目列表
- `/api/import` - PPT数据导入
- `/api/workflow/execute` - 工作流执行
- `/api/workflow/status/{workflow_id}` - 工作流状态查询

## 修复结果

✅ **所有硬编码的端口号已统一为配置化管理**
✅ **前端将根据环境配置动态使用正确的API端口**
✅ **视频导出功能端口不一致问题已解决**

## 验证方法

1. 启动API服务器：`uvicorn api_simple:app --host 0.0.0.0 --port 8002 --reload`
2. 访问健康检查：`http://localhost:8002/health`
3. 启动前端开发服务器：`npm run dev`
4. 测试PPT视频导出功能

## 注意事项

- 所有组件现在都从 `@/config/api` 导入 `API_BASE_URL`
- 如需更改API端口，只需修改 `.env.development` 文件
- 生产环境可通过 `.env.production` 文件配置不同的API地址
